openapi: 3.0.0
info:
  title: Food & Document Expiry Tracker - Notifications API
  version: 1.0.0
  description: Endpoints for managing notification preferences and history

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.expirytracker.app/api
    description: Production server

paths:
  /notifications/preferences:
    get:
      summary: Get user notification preferences
      tags:
        - Notifications
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Preferences retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreference'
        '401':
          $ref: '#/components/responses/Unauthorized'

    patch:
      summary: Update notification preferences
      tags:
        - Notifications
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePreferenceDto'
      responses:
        '200':
          description: Preferences updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreference'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/history:
    get:
      summary: Get notification history
      tags:
        - Notifications
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [PENDING, SENT, FAILED, CANCELLED]
        - name: cursor
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
      responses:
        '200':
          description: Notification history retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  notifications:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/test:
    post:
      summary: Send test notification
      tags:
        - Notifications
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Test notification sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Test notification sent successfully
                  notificationId:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Failed to send notification
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    NotificationPreference:
      type: object
      properties:
        id:
          type: string
        userId:
          type: string
        enabled:
          type: boolean
          description: Global notification toggle
        foodNotificationsEnabled:
          type: boolean
          description: Enable notifications for food items
        documentNotificationsEnabled:
          type: boolean
          description: Enable notifications for documents
        intervals:
          type: array
          items:
            type: integer
          description: Days before expiry to send notifications
          example: [30, 15, 7, 1]
        quietHoursEnabled:
          type: boolean
          description: Enable quiet hours
        quietHoursStart:
          type: string
          nullable: true
          pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
          example: '22:00'
        quietHoursEnd:
          type: string
          nullable: true
          pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
          example: '08:00'
        preferredTime:
          type: string
          nullable: true
          pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
          example: '09:00'
          description: Preferred daily notification time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    UpdatePreferenceDto:
      type: object
      properties:
        enabled:
          type: boolean
        foodNotificationsEnabled:
          type: boolean
        documentNotificationsEnabled:
          type: boolean
        intervals:
          type: array
          items:
            type: integer
            minimum: 1
          maxItems: 10
        quietHoursEnabled:
          type: boolean
        quietHoursStart:
          type: string
          pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
        quietHoursEnd:
          type: string
          pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'
        preferredTime:
          type: string
          pattern: '^([0-1][0-9]|2[0-3]):[0-5][0-9]$'

    Notification:
      type: object
      properties:
        id:
          type: string
        itemType:
          type: string
          enum: [FOOD, DOCUMENT]
        itemId:
          type: string
        itemName:
          type: string
        title:
          type: string
        body:
          type: string
        scheduledFor:
          type: string
          format: date-time
        sentAt:
          type: string
          format: date-time
          nullable: true
        status:
          type: string
          enum: [PENDING, SENT, FAILED, CANCELLED]
        errorMessage:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time

    Pagination:
      type: object
      properties:
        nextCursor:
          type: string
          nullable: true
        hasMore:
          type: boolean

    Error:
      type: object
      properties:
        statusCode:
          type: integer
        message:
          type: string
        error:
          type: string

  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
